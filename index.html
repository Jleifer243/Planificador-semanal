<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Escolar Sincronizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .header-gradient {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        .timetable-grid {
            display: grid;
            grid-template-columns: 120px repeat(5, minmax(220px, 1fr));
            gap: 1rem;
        }
        .day-header, .time-header {
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 700;
            border-radius: 0.75rem;
        }
        .day-header {
            font-size: 1.25rem;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }
        .time-header {
            font-size: 1rem;
            color: #374151;
            background-color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }
        .day-header .date-badge {
            background-color: rgba(255,255,255,0.25);
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
        }
        .day-header-0 { background-color: #7dd3fc; }
        .day-header-1 { background-color: #6ee7b7; }
        .day-header-2 { background-color: #fcd34d; }
        .day-header-3 { background-color: #fda4af; }
        .day-header-4 { background-color: #c4b5fd; }
        .class-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            height: 100%;
        }
        .class-card-header .subject {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }
        .task-block {
            padding: 0.5rem 0.75rem; border-radius: 0.5rem; position: relative; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .task-block:hover { transform: translateY(-2px); box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.08); }
        .color-pink { background-color: #fce7f3; border-left: 4px solid #ec4899; }
        .color-green { background-color: #dcfce7; border-left: 4px solid #22c55e; }
        .color-blue { background-color: #dbeafe; border-left: 4px solid #3b82f6; }
        .color-purple { background-color: #ede9fe; border-left: 4px solid #8b5cf6; }
        .color-amber { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .delete-btn {
            position: absolute; top: 50%; right: 8px; transform: translateY(-50%);
            color: #9ca3af; opacity: 0; transition: all 0.2s;
            width: 24px; height: 24px; display: grid; place-items: center; border-radius: 9999px;
        }
        .task-block:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #ef4444; background-color: #fee2e2; }
        .add-task-btn {
            width: 100%; border: 2px dashed #d1d5db; color: #6b7280; padding: 0.5rem;
            border-radius: 0.5rem; transition: all 0.2s; font-weight: 500; font-size: 0.875rem; margin-top: auto;
        }
        .add-task-btn:hover { background-color: #f9fafb; border-color: #9ca3af; color: #4b5563; }
        .modal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 40; display: grid; place-items: center;
        }
        .modal-content {
            background-color: white; padding: 32px; border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); width: 100%; max-width: 480px;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-6">
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div id="loading-text" class="text-xl font-semibold text-gray-700">Conectando...</div>
    </div>
    
    <!-- Modals -->
    <div id="edit-modal" class="modal-container hidden">
        <div class="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800">Añadir Tarea</h2>
            <form id="modal-form">
                <input type="hidden" id="block-time">
                <div class="mb-4">
                    <label for="block-desc" class="block text-sm font-medium text-gray-700 mb-1">Descripción de la Tarea</label>
                    <textarea id="block-desc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="modal-container hidden">
        <div class="modal-content text-center">
            <h2 class="text-xl font-bold mb-4 text-gray-800">¿Confirmar eliminación?</h2>
            <p class="text-gray-600 mb-6">Esta acción no se puede deshacer.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button>
                <button id="confirm-ok-btn" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">Eliminar</button>
            </div>
        </div>
    </div>

    <div class="max-w-screen-xl mx-auto">
        <header class="grid grid-cols-3 items-center mb-8 p-4 rounded-xl shadow-lg header-gradient text-white">
             <div class="flex items-center space-x-2">
                <button id="prev-week" class="p-2 rounded-full hover:bg-white/20 transition-colors" title="Semana anterior"><i class="fas fa-chevron-left fa-fw"></i></button>
                <button id="next-week" class="p-2 rounded-full hover:bg-white/20 transition-colors" title="Semana siguiente"><i class="fas fa-chevron-right fa-fw"></i></button>
             </div>
             <h1 id="week-title" class="text-xl md:text-2xl font-extrabold text-center tracking-wide">Planificador Semanal</h1>
             <div id="auth-container" class="flex items-center justify-end gap-4">
                <button id="go-today" class="px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition-colors flex items-center gap-2">
                   <i class="fas fa-calendar-day fa-fw"></i> <span class="hidden md:inline">Hoy</span>
                </button>
                <div id="sign-in-container">
                    <button id="sign-in-btn" class="px-4 py-2 rounded-lg text-sm font-semibold bg-white text-indigo-600 hover:bg-gray-100 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 110.3 512 0 401.8 0 265.8c0-13.2 1-26.2 2.7-39.1L244 256l241.3 5.8zM244 0c78.2 0 148.9 32.2 198.8 83.1l-63.5 61.8C349.5 111.3 300.9 88 244 88c-66.2 0-120.3 53.6-120.3 119.5s54.1 119.5 120.3 119.5c41.9 0 78.4-21.3 99.8-54.3l65.3 31.3c-37.2 73.1-114.7 124.9-204.1 124.9-132.8 0-241.3-108.4-241.3-241.3S111.2 0 244 0z"></path></svg>
                        Iniciar sesión con Google
                    </button>
                </div>
                <div id="user-info-container" class="hidden items-center gap-3">
                    <img id="user-photo" class="w-8 h-8 rounded-full" src="" alt="Foto de usuario">
                    <span id="user-name" class="text-sm font-semibold hidden md:inline"></span>
                    <button id="sign-out-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors" title="Cerrar sesión">
                        <i class="fas fa-sign-out-alt fa-fw"></i>
                    </button>
                </div>
             </div>
        </header>

        <div class="overflow-x-auto">
            <div id="timetable-container" class="timetable-grid"></div>
        </div>
    </div>

    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- TU CONFIGURACIÓN PERSONAL DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAYS4xwr-ieVslIlymnLcZRll-R6Cjcc_c",
            authDomain: "planificador-semanal-54fd2.firebaseapp.com",
            projectId: "planificador-semanal-54fd2",
            storageBucket: "planificador-semanal-54fd2.appspot.com",
            messagingSenderId: "505025151757",
            appId: "1:505025151757:web:f81087bd24d760cf5be644"
        };

        // --- HORARIO FIJO Y CONSTANTES ---
        const scheduleTemplate = {
            'day_0': [{ time: '10:15', group: 'Lengua 4º ESO', isClass: true }],
            'day_1': [{ time: '08:15', group: 'Latín 4º ESO', isClass: true }, { time: '09:15', group: 'Lengua 4º ESO', isClass: true }],
            'day_2': [{ time: '08:15', group: 'Oratoria y Debate 3º', isClass: true }, { time: '10:15', group: 'Latín 4º ESO', isClass: true }],
            'day_3': [{ time: '08:15', group: 'Oratoria y Debate 3º', isClass: true }, { time: '09:15', group: 'Latín 4º ESO', isClass: true }, { time: '10:15', group: 'Lengua 4º ESO', isClass: true }],
            'day_4': [{ time: '08:15', group: 'Lengua 4º ESO', isClass: true }, { time: '09:15', group: 'ATEDU 3º ESO', isClass: true }]
        };
        const timeSlots = [
            { label: '1ª Hora', timeValue: '08:15' },
            { label: '2ª Hora', timeValue: '09:15' },
            { label: '3ª Hora', timeValue: '10:15' }
        ];
        
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setHours(0,0,0,0);
            return new Date(d.setDate(diff));
        }
        function getWeekId(d) {
            const monday = getMonday(d);
            return `semana-${monday.getFullYear()}-${String(monday.getMonth() + 1).padStart(2, '0')}-${String(monday.getDate()).padStart(2, '0')}`;
        }
        
        async function main() {
            let currentMonday = getMonday(new Date()); 
            let weeklyData = {};
            let itemToDelete = { dayIndex: null, blockId: null };
            let currentEditing = { dayIndex: null, blockId: null };
            let db, auth, userId;

            const weekTitleEl = document.getElementById('week-title');
            const timetableContainer = document.getElementById('timetable-container');
            const editModal = document.getElementById('edit-modal');
            const modalForm = document.getElementById('modal-form');
            const cancelBtn = document.getElementById('cancel-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');

            const signInContainer = document.getElementById('sign-in-container');
            const userInfoContainer = document.getElementById('user-info-container');
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            const goTodayBtn = document.getElementById('go-today');
            
            async function initFirebase() {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // User is signed in.
                            userId = user.uid;
                            userPhoto.src = user.photoURL;
                            userName.textContent = user.displayName;

                            signInContainer.classList.add('hidden');
                            userInfoContainer.classList.remove('hidden');
                            userInfoContainer.classList.add('flex');

                            loadingText.textContent = "Cargando tu planificador...";
                            loadingOverlay.classList.remove('hidden');

                            await renderWeek();
                        } else {
                            // User is signed out.
                            userId = null;
                            signInContainer.classList.remove('hidden');
                            userInfoContainer.classList.add('hidden');
                            userInfoContainer.classList.remove('flex');
                            
                            timetableContainer.innerHTML = `<div class="col-start-1 col-span-6 text-center p-10 text-gray-500 font-semibold">Por favor, inicia sesión con Google para cargar tu planificador.</div>`;
                            weekTitleEl.textContent = 'Planificador Semanal';
                            loadingOverlay.classList.add('hidden');
                        }
                    });

                } catch (error) {
                    console.error("Error al inicializar Firebase:", error);
                    alert("No se pudo conectar con el servicio de guardado.");
                    loadingText.textContent = "Error de conexión";
                }
            }

            async function handleSignIn() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Error al iniciar sesión:", error);
                    alert("No se pudo iniciar sesión. Inténtalo de nuevo.");
                }
            }

            async function handleSignOut() {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                }
            }

            async function renderWeek() {
                if (!userId) return;

                const monday = currentMonday;
                const friday = new Date(monday);
                friday.setDate(monday.getDate() + 4);
                const mondayStr = monday.toLocaleDateString('es-ES', { day: 'numeric', month: monday.getMonth() !== friday.getMonth() ? 'long' : undefined });
                const fridayStr = friday.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                weekTitleEl.textContent = `Semana del ${mondayStr} al ${fridayStr}`;

                const weekId = getWeekId(currentMonday);
                const docRef = doc(db, `users/${userId}/weeks/${weekId}`);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    weeklyData = docSnap.data().data;
                } else {
                    weeklyData = {};
                    Object.keys(scheduleTemplate).forEach(dayKey => {
                        weeklyData[dayKey] = scheduleTemplate[dayKey].map(block => ({...block, desc: '', id: self.crypto.randomUUID() }));
                    });
                    await saveData();
                }
                drawTimetable(weeklyData);
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.classList.add('hidden'); loadingOverlay.style.opacity = '1'; }, 300);
            }

            async function saveData() {
                if (!userId || !db) return;
                const weekId = getWeekId(currentMonday);
                const docRef = doc(db, `users/${userId}/weeks/${weekId}`);
                try {
                    await setDoc(docRef, { data: weeklyData });
                } catch (error) {
                    console.error("Error al guardar los datos:", error);
                }
            }
            
            function drawTimetable(data) {
                timetableContainer.innerHTML = '';
                const dayNames = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];

                timetableContainer.appendChild(document.createElement('div'));
                dayNames.forEach((dayName, dayIndex) => {
                    const dayDate = new Date(currentMonday);
                    dayDate.setDate(currentMonday.getDate() + dayIndex);
                    const dayHeader = document.createElement('div');
                    dayHeader.className = `day-header day-header-${dayIndex}`;
                    dayHeader.innerHTML = `<span>${dayName}</span><span class="date-badge">${dayDate.getDate()}</span>`;
                    timetableContainer.appendChild(dayHeader);
                });

                timeSlots.forEach(slot => {
                    const timeHeader = document.createElement('div');
                    timeHeader.className = 'time-header';
                    timeHeader.textContent = slot.label;
                    timetableContainer.appendChild(timeHeader);

                    dayNames.forEach((_, dayIndex) => {
                        const dayKey = `day_${dayIndex}`;
                        const blocksForDay = data[dayKey] || [];
                        const blocksInSlot = blocksForDay.filter(b => b.time === slot.timeValue);
                        const mainClass = blocksInSlot.find(b => b.isClass);

                        if (mainClass) {
                            const card = document.createElement('div');
                            card.className = 'class-card';
                            
                            let color = '#d1d5db';
                            if (mainClass.group.includes('Lengua')) color = '#7dd3fc';
                            else if (mainClass.group.includes('Latín')) color = '#fcd34d';
                            else if (mainClass.group.includes('Oratoria')) color = '#6ee7b7';
                            else if (mainClass.group.includes('ATEDU')) color = '#c4b5fd';
                            card.style.borderTop = `4px solid ${color}`;
                            
                            const tasksInSlot = blocksInSlot.filter(b => !b.isClass);
                            card.innerHTML = `<div class="class-card-header"><p class="subject">${mainClass.group}</p></div><div class="tasks-container flex flex-col gap-2"></div>`;
                            
                            const tasksContainer = card.querySelector('.tasks-container');
                            tasksInSlot.forEach(task => tasksContainer.appendChild(createBlockElement(task, dayIndex)));

                            const addBtn = document.createElement('button');
                            addBtn.className = 'add-task-btn';
                            addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Añadir tarea';
                            addBtn.dataset.dayIndex = dayIndex;
                            addBtn.dataset.time = slot.timeValue;
                            tasksContainer.appendChild(addBtn);
                            
                            timetableContainer.appendChild(card);
                        } else {
                            timetableContainer.appendChild(document.createElement('div'));
                        }
                    });
                });
            }
            
            function createBlockElement(block, dayIndex) {
                const blockEl = document.createElement('div');
                blockEl.dataset.dayIndex = dayIndex;
                blockEl.dataset.blockId = block.id;
                blockEl.className = `task-block ${block.color}`;
                blockEl.innerHTML = `<p class="text-gray-700 text-sm pointer-events-none pr-6">${block.desc}</p><div class="delete-btn" title="Eliminar tarea"><i class="fas fa-times"></i></div>`;
                return blockEl;
            }

            function openEditModal(dayIndex, blockId = null, time = null) {
                currentEditing = { dayIndex, blockId };
                modalForm.reset();
                if (blockId) {
                    const block = weeklyData[`day_${dayIndex}`].find(b => b.id === blockId);
                    document.getElementById('modal-title').textContent = 'Editar Tarea';
                    document.getElementById('block-desc').value = block.desc;
                    document.getElementById('block-time').value = block.time;
                } else {
                    document.getElementById('modal-title').textContent = 'Añadir Tarea';
                    document.getElementById('block-time').value = time;
                }
                editModal.classList.remove('hidden');
            }
            function closeEditModal() { editModal.classList.add('hidden'); }
            function openConfirmModal(dayIndex, blockId) {
                itemToDelete = { dayIndex, blockId };
                confirmModal.classList.remove('hidden');
            }
            function closeConfirmModal() {
                itemToDelete = { dayIndex: null, blockId: null };
                confirmModal.classList.add('hidden');
            }
            
            signInBtn.addEventListener('click', handleSignIn);
            signOutBtn.addEventListener('click', handleSignOut);

            timetableContainer.addEventListener('click', (e) => {
                const addBtn = e.target.closest('.add-task-btn');
                if (addBtn) { openEditModal(parseInt(addBtn.dataset.dayIndex), null, addBtn.dataset.time); return; }
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const blockEl = e.target.closest('.task-block');
                    openConfirmModal(parseInt(blockEl.dataset.dayIndex), blockEl.dataset.blockId);
                    return;
                }
                const blockEl = e.target.closest('.task-block');
                if (blockEl) { openEditModal(parseInt(blockEl.dataset.dayIndex), blockEl.dataset.blockId); }
            });

            modalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const { dayIndex, blockId } = currentEditing;
                const dayKey = `day_${dayIndex}`;
                const time = document.getElementById('block-time').value;

                const mainClass = weeklyData[dayKey].find(b => b.time === time && b.isClass);
                let newColor = 'color-blue';
                if (mainClass) {
                    const subject = mainClass.group;
                    if (subject.includes('Lengua')) newColor = 'color-blue';
                    else if (subject.includes('Latín')) newColor = 'color-amber';
                    else if (subject.includes('Oratoria')) newColor = 'color-green';
                    else if (subject.includes('ATEDU')) newColor = 'color-purple';
                }

                const newBlockData = {
                    time: time, desc: document.getElementById('block-desc').value,
                    color: newColor, isClass: false
                };

                if (blockId) {
                    const idx = weeklyData[dayKey].findIndex(b => b.id === blockId);
                    newBlockData.id = blockId;
                    weeklyData[dayKey][idx] = { ...weeklyData[dayKey][idx], ...newBlockData };
                } else {
                    newBlockData.id = self.crypto.randomUUID();
                    if (!weeklyData[dayKey]) weeklyData[dayKey] = [];
                    weeklyData[dayKey].push(newBlockData);
                }
                await saveData();
                closeEditModal();
                drawTimetable(weeklyData);
            });
            
            confirmOkBtn.addEventListener('click', async () => {
                const { dayIndex, blockId } = itemToDelete;
                if (dayIndex !== null && blockId !== null) {
                    const dayKey = `day_${dayIndex}`;
                    weeklyData[dayKey] = weeklyData[dayKey].filter(b => b.id !== blockId);
                    await saveData();
                    drawTimetable(weeklyData);
                }
                closeConfirmModal();
            });

            prevWeekBtn.addEventListener('click', () => { if(userId) { currentMonday.setDate(currentMonday.getDate() - 7); renderWeek(); }});
            nextWeekBtn.addEventListener('click', () => { if(userId) { currentMonday.setDate(currentMonday.getDate() + 7); renderWeek(); }});
            goTodayBtn.addEventListener('click', () => { if(userId) { currentMonday = getMonday(new Date()); renderWeek(); }});
            cancelBtn.addEventListener('click', closeEditModal);
            confirmCancelBtn.addEventListener('click', closeConfirmModal);
            
            initFirebase();
        }

        main();
    </script>
</body>
</html>

