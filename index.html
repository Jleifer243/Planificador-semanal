<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificador Escolar Elegante</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .header-gradient { background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%); }
    .timetable-grid { display: grid; grid-template-columns: 120px repeat(5, minmax(220px, 1fr)); gap: 1rem; }
    .day-header, .time-header { padding: 0.75rem 1rem; text-align: center; font-weight: 700; border-radius: 0.75rem; }
    .day-header { font-size: 1.25rem; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
    .time-header { font-size: 1rem; color: #374151; background-color: #f9fafb; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
    .day-header .date-badge { background-color: rgba(255,255,255,0.25); border-radius: 9999px; font-size: 0.875rem; font-weight: 600; padding: 0.125rem 0.5rem; }
    .day-header-0 { background-color: #7dd3fc; } .day-header-1 { background-color: #6ee7b7; } .day-header-2 { background-color: #fcd34d; } .day-header-3 { background-color: #fda4af; } .day-header-4 { background-color: #c4b5fd; }
    .class-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1); padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; height: 100%; }
    .class-card-header .subject { font-size: 1.1rem; font-weight: 700; color: #1f2937; }
    .task-block { padding: 0.5rem 0.75rem; border-radius: 0.5rem; position: relative; cursor: pointer; transition: transform .2s, box-shadow .2s; }
    .task-block:hover { transform: translateY(-2px); box-shadow: 0 4px 12px 0 rgba(0,0,0,.08); }
    .color-pink { background-color: #fce7f3; border-left: 4px solid #ec4899; }
    .color-green { background-color: #dcfce7; border-left: 4px solid #22c55e; }
    .color-blue { background-color: #dbeafe; border-left: 4px solid #3b82f6; }
    .color-purple { background-color: #ede9fe; border-left: 4px solid #8b5cf6; }
    .color-amber { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
    .delete-btn { position: absolute; top: 50%; right: 8px; transform: translateY(-50%); color: #9ca3af; opacity: 0; transition: all .2s; width: 24px; height: 24px; display: grid; place-items: center; border-radius: 9999px; }
    .task-block:hover .delete-btn { opacity: 1; } .delete-btn:hover { color: #ef4444; background-color: #fee2e2; }
    .add-task-btn { width: 100%; border: 2px dashed #d1d5db; color: #6b7280; padding: 0.5rem; border-radius: 0.5rem; transition: all .2s; font-weight: 500; font-size: .875rem; margin-top: auto; }
    .add-task-btn:hover { background-color: #f9fafb; border-color: #9ca3af; color: #4b5563; }
    .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.5); z-index: 40; display: grid; place-items: center; }
    .modal-content { background-color: white; padding: 32px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,.25); width: 100%; max-width: 480px; }
    .hidden { display: none; }
  </style>
</head>
<body class="p-4 md:p-6">
  <!-- Modales -->
  <div id="edit-modal" class="modal-container hidden">
    <div class="modal-content">
      <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-800">Añadir Tarea</h2>
      <form id="modal-form">
        <input id="block-time" type="hidden" />
        <div class="mb-4">
          <label for="block-desc" class="block text-sm font-medium text-gray-700 mb-1">Descripción de la Tarea</label>
          <textarea id="block-desc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" id="cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button>
          <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirm-modal" class="modal-container hidden">
    <div class="modal-content text-center">
      <h2 class="text-xl font-bold mb-4 text-gray-800">¿Confirmar eliminación?</h2>
      <p class="text-gray-600 mb-6">Esta acción no se puede deshacer.</p>
      <div class="flex justify-center space-x-4">
        <button id="confirm-cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-semibold">Cancelar</button>
        <button id="confirm-ok-btn" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">Eliminar</button>
      </div>
    </div>
  </div>

  <div class="max-w-screen-xl mx-auto">
    <header class="grid grid-cols-3 items-center mb-8 p-4 rounded-xl shadow-lg header-gradient text-white">
      <div class="flex items-center space-x-2">
        <button id="prev-week" class="p-2 rounded-full hover:bg-white/20 transition-colors" title="Semana anterior"><i class="fas fa-chevron-left fa-fw"></i></button>
        <button id="next-week" class="p-2 rounded-full hover:bg-white/20 transition-colors" title="Semana siguiente"><i class="fas fa-chevron-right fa-fw"></i></button>
      </div>
      <h1 id="week-title" class="text-xl md:text-2xl font-extrabold text-center tracking-wide">Cargando...</h1>
      <div class="flex items-center justify-end space-x-2">
        <button id="go-today" class="px-4 py-2 rounded-lg text-sm font-semibold hover:bg-white/20 transition-colors flex items-center gap-2">
          <i class="fas fa-calendar-day fa-fw"></i> <span class="hidden md:inline">Hoy</span>
        </button>
      </div>
    </header>

    <!-- Botón login -->
    <div id="login-container" style="text-align:center; margin-bottom:16px;">
      <button id="google-login-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-300">
        Iniciar sesión con Google
      </button>
    </div>

    <div class="overflow-x-auto">
      <div id="timetable-container" class="timetable-grid"></div>
    </div>
  </div>

  <!-- Tu lógica original del planificador (sin cambios estructurales) -->
  <script type="module">
    const scheduleTemplate = {
      'day_0': [{ time: '10:15', group: 'Lengua 4º ESO', isClass: true }],
      'day_1': [{ time: '08:15', group: 'Latín 4º ESO', isClass: true }, { time: '09:15', group: 'Lengua 4º ESO', isClass: true }],
      'day_2': [{ time: '08:15', group: 'Oratoria y Debate 3º', isClass: true }, { time: '10:15', group: 'Latín 4º ESO', isClass: true }],
      'day_3': [{ time: '08:15', group: 'Oratoria y Debate 3º', isClass: true }, { time: '09:15', group: 'Latín 4º ESO', isClass: true }, { time: '10:15', group: 'Lengua 4º ESO', isClass: true }],
      'day_4': [{ time: '08:15', group: 'Lengua 4º ESO', isClass: true }, { time: '09:15', group: 'ATEDU 3º ESO', isClass: true }]
    };
    const timeSlots = [
      { label: '1ª Hora', timeValue: '08:15' },
      { label: '2ª Hora', timeValue: '09:15' },
      { label: '3ª Hora', timeValue: '10:15' }
    ];

    function getMonday(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); d.setHours(0,0,0,0); return new Date(d.setDate(diff)); }
    function getWeekId(d) { const m = getMonday(d); return `planner-${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,'0')}-${String(m.getDate()).padStart(2,'0')}`; }

    document.addEventListener('DOMContentLoaded', () => {
      let currentMonday = getMonday(new Date());
      let weeklyData = {};
      let itemToDelete = { dayIndex: null, blockId: null };
      let currentEditing = { dayIndex: null, blockId: null };

      const weekTitleEl = document.getElementById('week-title');
      const timetableContainer = document.getElementById('timetable-container');
      const editModal = document.getElementById('edit-modal');
      const modalForm = document.getElementById('modal-form');
      const cancelBtn = document.getElementById('cancel-btn');
      const confirmModal = document.getElementById('confirm-modal');
      const confirmOkBtn = document.getElementById('confirm-ok-btn');
      const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

      function renderWeek() {
        const monday = currentMonday;
        const friday = new Date(monday); friday.setDate(monday.getDate() + 4);
        const mondayStr = monday.toLocaleDateString('es-ES', { day: 'numeric', month: monday.getMonth() !== friday.getMonth() ? 'long' : undefined });
        const fridayStr = friday.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
        weekTitleEl.textContent = `Semana del ${mondayStr} al ${fridayStr}`;
        const weekId = getWeekId(currentMonday);
        const savedData = localStorage.getItem(weekId);
        if (savedData) { weeklyData = JSON.parse(savedData); }
        else { weeklyData = {}; Object.keys(scheduleTemplate).forEach(k => { weeklyData[k] = scheduleTemplate[k].map(b => ({...b, desc:'', id:self.crypto.randomUUID()})); }); saveData(); }
        drawTimetable(weeklyData);
      }

      function drawTimetable(data) {
        timetableContainer.innerHTML = '';
        const dayNames = ['Lunes','Martes','Miércoles','Jueves','Viernes'];
        timetableContainer.appendChild(document.createElement('div'));
        dayNames.forEach((name, idx) => {
          const dayDate = new Date(currentMonday); dayDate.setDate(currentMonday.getDate()+idx);
          const h = document.createElement('div'); h.className = `day-header day-header-${idx}`;
          h.innerHTML = `<span>${name}</span><span class="date-badge">${dayDate.getDate()}</span>`;
          timetableContainer.appendChild(h);
        });
        const timeSlots = [{label:'1ª Hora',timeValue:'08:15'},{label:'2ª Hora',timeValue:'09:15'},{label:'3ª Hora',timeValue:'10:15'}];
        timeSlots.forEach(slot=>{
          const th = document.createElement('div'); th.className='time-header'; th.textContent=slot.label; timetableContainer.appendChild(th);
          ['Lunes','Martes','Miércoles','Jueves','Viernes'].forEach((_,dayIndex)=>{
            const dayKey=`day_${dayIndex}`; const blocks=data[dayKey]||[]; const blocksInSlot=blocks.filter(b=>b.time===slot.timeValue); const mainClass=blocksInSlot.find(b=>b.isClass);
            if(mainClass){
              const card=document.createElement('div'); card.className='class-card';
              let color='#d1d5db'; if(mainClass.group.includes('Lengua'))color='#7dd3fc'; else if(mainClass.group.includes('Latín'))color='#fcd34d'; else if(mainClass.group.includes('Oratoria'))color='#6ee7b7'; else if(mainClass.group.includes('ATEDU'))color='#c4b5fd';
              card.style.borderTop=`4px solid ${color}`;
              const tasksInSlot=blocksInSlot.filter(b=>!b.isClass);
              card.innerHTML=`<div class="class-card-header"><p class="subject">${mainClass.group}</p></div><div class="tasks-container flex flex-col gap-2"></div>`;
              const tasksContainer=card.querySelector('.tasks-container');
              tasksInSlot.forEach(task=>tasksContainer.appendChild(createBlockElement(task,dayIndex)));
              const addBtn=document.createElement('button'); addBtn.className='add-task-btn'; addBtn.innerHTML='<i class="fas fa-plus mr-2"></i>Añadir tarea'; addBtn.dataset.dayIndex=dayIndex; addBtn.dataset.time=slot.timeValue; tasksContainer.appendChild(addBtn);
              timetableContainer.appendChild(card);
            } else {
              timetableContainer.appendChild(document.createElement('div'));
            }
          });
        });
      }

      function createBlockElement(block, dayIndex){ const el=document.createElement('div'); el.dataset.dayIndex=dayIndex; el.dataset.blockId=block.id; el.className=`task-block ${block.color}`; el.innerHTML=`<p class="text-gray-700 text-sm pointer-events-none pr-6">${block.desc}</p><div class="delete-btn" title="Eliminar tarea"><i class="fas fa-times"></i></div>`; return el; }
      function saveData(){ localStorage.setItem(getWeekId(currentMonday), JSON.stringify(weeklyData)); }

      function openEditModal(dayIndex, blockId=null, time=null){ currentEditing={dayIndex,blockId}; modalForm.reset(); if(blockId){ const b=weeklyData[`day_${dayIndex}`].find(x=>x.id===blockId); document.getElementById('modal-title').textContent='Editar Tarea'; document.getElementById('block-desc').value=b.desc; document.getElementById('block-time').value=b.time; } else { document.getElementById('modal-title').textContent='Añadir Tarea'; document.getElementById('block-time').value=time; } editModal.classList.remove('hidden'); }
      function closeEditModal(){ editModal.classList.add('hidden'); }
      function openConfirmModal(dayIndex, blockId){ itemToDelete={dayIndex,blockId}; confirmModal.classList.remove('hidden'); }
      function closeConfirmModal(){ itemToDelete={dayIndex:null,blockId:null}; confirmModal.classList.add('hidden'); }

      timetableContainer.addEventListener('click',(e)=>{ const addBtn=e.target.closest('.add-task-btn'); if(addBtn){ openEditModal(parseInt(addBtn.dataset.dayIndex),null,addBtn.dataset.time); return; } const del=e.target.closest('.delete-btn'); if(del){ const blk=e.target.closest('.task-block'); openConfirmModal(parseInt(blk.dataset.dayIndex), blk.dataset.blockId); return; } const blk=e.target.closest('.task-block'); if(blk){ openEditModal(parseInt(blk.dataset.dayIndex), blk.dataset.blockId); } });
      modalForm.addEventListener('submit',(e)=>{ e.preventDefault(); const {dayIndex,blockId}=currentEditing; const dayKey=`day_${dayIndex}`; const time=document.getElementById('block-time').value; const main=weeklyData[dayKey].find(b=>b.time===time && b.isClass); let color='color-blue'; if(main){ const s=main.group; if(s.includes('Lengua'))color='color-blue'; else if(s.includes('Latín'))color='color-amber'; else if(s.includes('Oratoria'))color='color-green'; else if(s.includes('ATEDU'))color='color-purple'; } const data={ time, desc:document.getElementById('block-desc').value, color, isClass:false }; if(blockId){ const i=weeklyData[dayKey].findIndex(b=>b.id===blockId); data.id=blockId; data.group=weeklyData[dayKey][i].group; weeklyData[dayKey][i]=data; } else { data.id=self.crypto.randomUUID(); if(!weeklyData[dayKey])weeklyData[dayKey]=[]; data.group=main?main.group:'Tarea'; weeklyData[dayKey].push(data); } saveData(); closeEditModal(); renderWeek(); });
      document.getElementById('prev-week').addEventListener('click',()=>{ currentMonday.setDate(currentMonday.getDate()-7); renderWeek(); });
      document.getElementById('next-week').addEventListener('click',()=>{ currentMonday.setDate(currentMonday.getDate()+7); renderWeek(); });
      document.getElementById('go-today').addEventListener('click',()=>{ currentMonday=getMonday(new Date()); renderWeek(); });
      cancelBtn.addEventListener('click', closeEditModal);
      confirmCancelBtn.addEventListener('click', closeConfirmModal);
      document.getElementById('confirm-ok-btn').addEventListener('click',()=>{ const {dayIndex,blockId}=itemToDelete; if(dayIndex!==null && blockId!==null){ const k=`day_${dayIndex}`; weeklyData[k]=weeklyData[k].filter(b=>b.id!==blockId); saveData(); renderWeek(); } closeConfirmModal(); });
      renderWeek();
    });
  </script>

  <!-- Overlay de carga -->
  <div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; justify-content:center; align-items:center;">
    <span class="font-bold text-2xl mb-2">Conectando...</span>
  </div>

  <!-- Firebase: inicialización robusta + popup primero y redirect de respaldo -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      initializeAuth,
      browserLocalPersistence,
      browserSessionPersistence,
      inMemoryPersistence,
      browserPopupRedirectResolver,
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfuJa4U3H2Uo4t1qKxeuJTGym70s8QauQ",
      authDomain: "planificador-final-app.firebaseapp.com",
      projectId: "planificador-final-app",
      storageBucket: "planificador-final-app.appspot.com",
      messagingSenderId: "1.018171067065e+12",
      appId: "1:1.018171067065e+12:web:201a8d7ba1445e73afa968"
    };

    const app = initializeApp(firebaseConfig);
    // Inicializa Auth con persistencias en cascada y resolver explícito para popup/redirect
    const auth = initializeAuth(app, {
      persistence: [browserLocalPersistence, browserSessionPersistence, inMemoryPersistence],
      popupRedirectResolver: browserPopupRedirectResolver
    }); // Evita pérdida de estado en navegadores con particionado/bloqueo de cookies [17][11]
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    const loginBtn = document.getElementById('google-login-btn');
    const loadingOverlay = document.getElementById('loading-overlay');

    function getMonday(d){ d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); d.setHours(0,0,0,0); return new Date(d.setDate(diff)); }
    function getWeekId(d){ const m = getMonday(d); const y = m.getFullYear(); const mo = String(m.getMonth()+1).padStart(2,'0'); const da = String(m.getDate()).padStart(2,'0'); return `planner-${y}-${mo}-${da}`; }

    // Sincroniza Firestore cuando tu lógica guarda en localStorage
    const _setItem = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(key, value){
      _setItem(key, value);
      try{
        if(key.startsWith('planner-')){
          const user = getAuth().currentUser;
          if(user){
            const payload = JSON.parse(value);
            setDoc(doc(db,'users',user.uid), { planner: { [key]: payload } }, { merge: true });
          }
        }
      }catch(e){ console.error('Sync error', e); }
    }; // Mantiene tu flujo de guardado y añade persistencia remota por usuario/semana [23]

    if (loginBtn){
      loginBtn.addEventListener('click', async ()=>{
        loadingOverlay.style.display = 'flex';
        try {
          await signInWithPopup(auth, provider); // Preferente para evitar problemas de state con redirect [23]
        } catch (err) {
          const blocked = err && (err.code === 'auth/popup-blocked' || err.code === 'auth/cancelled-popup-request' || err.code === 'auth/popup-closed-by-user');
          if (blocked) {
            await signInWithRedirect(auth, provider); // Respaldo si el popup es bloqueado por el navegador [23]
          } else {
            alert('Error en login (popup): ' + (err && err.message ? err.message : err));
            loadingOverlay.style.display = 'none';
          }
        }
      });
    } // Dispara login por gesto de usuario y cae a redirect cuando el popup no es viable [23]

    // Consume resultado del redirect al volver y limpia overlay
    getRedirectResult(auth).then(()=>{ loadingOverlay.style.display='none'; })
    .catch((error)=>{ loadingOverlay.style.display='none'; if(error?.message){ alert('Error en login (redirect): ' + error.message); } }); // Evita quedarse en “Conectando…” tras volver del IdP [12]

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        loadingOverlay.style.display = 'flex';
        const weekId = getWeekId(new Date());
        try{
          const snap = await getDoc(doc(db,'users',user.uid));
          if(snap.exists() && snap.data().planner && snap.data().planner[weekId]){
            _setItem(weekId, JSON.stringify(snap.data().planner[weekId]));
            const goToday = document.getElementById('go-today');
            if(goToday){ goToday.click(); }
          }
        }catch(e){ console.error(e); }
        loadingOverlay.style.display = 'none';
      }else{
        loadingOverlay.style.display = 'none';
      }
    }); // Refresca la UI cuando hay sesión válida y carga la semana actual del usuario [23]
  </script>
</body>
</html>
